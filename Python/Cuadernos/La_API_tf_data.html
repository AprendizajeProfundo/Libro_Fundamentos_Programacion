
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Canalización de datos. La API tf.data &#8212; Fundamentos de Programación</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo-final-ap.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Fundamentos de Programación</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../tutorial.html">
                    <span style="color:#F72585">Bienvenido(a)</span>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Primeros Pasos
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Inicio/Cuadernos/Consideraciones.html">
   <span style="color:#F72585">
    Conociendo el Libro
   </span>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introducción
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="py_00.html">
   <span style="color:#F72585">
    Conceptos básicos de programación
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_01.html">
   <span style="color:#F72585">
    Introducción al lenguaje de programación Python
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_02.html">
   <span style="color:#F72585">
    Tipos de Datos Básicos
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_03.html">
   <span style="color:#F72585">
    Operadores aritméticos y lógicos
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_04.html">
   <span style="color:#F72585">
    Estructuras de control
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_05.html">
   <span style="color:#F72585">
    Funciones en Python
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_06.html">
   <span style="color:#F72585">
    Iterables e iteradores
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_07.html">
   <span style="color:#F72585">
    Tuplas
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_08.html">
   <span style="color:#F72585">
    Listas
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_09.html">
   <span style="color:#F72585">
    Diccionarios
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_10.html">
   <span style="color:#F72585">
    Conjuntos
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_11.html">
   <span style="color:#F72585">
    Programación orientada a Objetos en Python
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_12.html">
   <span style="color:#F72585">
    Decoradores
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="py_13.html">
   <span style="color:#F72585">
    Patrones para Programación orientada a Objetos en Python
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Taller_Numpy.html">
   <span style="color:#F72585">
    Taller de numpy
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Taller_Pandas.html">
   <span style="color:#F72585">
    Taller de manejo de Datos en Pandas
   </span>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Pytorch
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../Pytorch/Cuadernos/Pytorch_01.html">
   <span style="color:#F72585">
    Primeros pasos con PyTorch
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Pytorch/Cuadernos/Pytorch_02.html">
   <span style="color:#F72585">
    Tensores en PyTorch
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Pytorch/Cuadernos/Pytorch_03.html">
   <span style="color:#F72585">
    DataSets y DataLoaders
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Pytorch/Cuadernos/Pytorch_04.html">
   <span style="color:#F72585">
    Transforms
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Pytorch/Cuadernos/Pytorch_05.html">
   <span style="color:#F72585">
    Diferenciación automática con torch.autograd
   </span>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../Pytorch/Cuadernos/Pytorch_06.html">
   <span style="color:#F72585">
    Optimización con torch
   </span>
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  TensorFlow
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../TensorFlow/Cuadernos/Tensorflow-01.html">
   <span style="color:#F72585">
    Inicio Rápido
   </span>
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/AprendizajeProfundo/Libro_Fundamentos_Programacion/main?urlpath=tree/Python/Cuadernos/La_API_tf_data.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/AprendizajeProfundo/Libro_Fundamentos_Programacion/blob/main/Python/Cuadernos/La_API_tf_data.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/AprendizajeProfundo/Libro_Fundamentos_Programacion"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/AprendizajeProfundo/Libro_Fundamentos_Programacion/issues/new?title=Issue%20on%20page%20%2FPython/Cuadernos/La_API_tf_data.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/AprendizajeProfundo/Libro_Fundamentos_Programacion/edit/main/Python/Cuadernos/La_API_tf_data.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/Python/Cuadernos/La_API_tf_data.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-introduccion-span">
   <span style="color:#4361EE">
    Introducción
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-importa-librerias-span">
   <span style="color:#4361EE">
    Importa librerías
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-esenciales-span">
   <span style="color:#4361EE">
    Esenciales
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#consumo-de-datos-usando-reduccion-reduce">
     Consumo de datos usando reducción: reduce
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-estructura-del-conjunto-de-datos-span">
   <span style="color:#4361EE">
    Estructura del conjunto de datos
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-leer-datos-de-entrada-span">
   <span style="color:#4361EE">
    Leer datos de entrada
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-matrices-numpy-span">
     <span style="color:#4CC9F0">
      Consumir matrices Numpy
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-generadores-de-python-span">
     <span style="color:#4CC9F0">
      Consumir generadores de Python
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-ejemplo-realista-con-imagenes-span">
     <span style="color:#4CC9F0">
      Ejemplo realista con imágenes
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-datos-de-texto-span">
     <span style="color:#4CC9F0">
      Consumir datos de texto
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-datos-csv-span">
     <span style="color:#4CC9F0">
      Consumir datos CSV
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-conjuntos-de-archivos-span">
     <span style="color:#4CC9F0">
      Consumir conjuntos de archivos
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-loteo-de-elementos-del-dataset-span">
   <span style="color:#4361EE">
    Loteo de elementos del dataset
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-loteo-simple-span">
     <span style="color:#4CC9F0">
      Loteo simple
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-loteo-de-tensores-con-acolchamiento-span">
     <span style="color:#4CC9F0">
      Loteo de tensores con acolchamiento
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-flujo-de-entrenamiento-span">
   <span style="color:#4361EE">
    Flujo de entrenamiento
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-procesando-multiples-epochs-span">
     <span style="color:#4CC9F0">
      Procesando múltiples epochs
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-mezclar-los-dato-de-entrada-span">
   <span style="color:#4361EE">
    Mezclar los dato de entrada
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-preprocesamiento-de-datos-span">
   <span style="color:#4361EE">
    Preprocesamiento de datos
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-decodificando-imagenes-y-cambiar-su-tamano-span">
     <span style="color:#4CC9F0">
      Decodificando imagenes y cambiar su tamaño
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-aplicando-funciones-de-python-span">
     <span style="color:#4CC9F0">
      Aplicando funciones de Python
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ventaneo-de-series-de-tiempo">
   Ventaneo De series de tiempo
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-remuestreo-span">
   <span style="color:#4361EE">
    Remuestreo
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-muestreo-de-datasets-span">
     <span style="color:#4CC9F0">
      Muestreo de Datasets
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-remuestreo-de-rechazo-span">
   <span style="color:#4361EE">
    Remuestreo de rechazo
   </span>
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1><span style="color:#F72585">Canalización de datos. La API tf.data</span></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-introduccion-span">
   <span style="color:#4361EE">
    Introducción
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-importa-librerias-span">
   <span style="color:#4361EE">
    Importa librerías
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-esenciales-span">
   <span style="color:#4361EE">
    Esenciales
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#consumo-de-datos-usando-reduccion-reduce">
     Consumo de datos usando reducción: reduce
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-estructura-del-conjunto-de-datos-span">
   <span style="color:#4361EE">
    Estructura del conjunto de datos
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-leer-datos-de-entrada-span">
   <span style="color:#4361EE">
    Leer datos de entrada
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-matrices-numpy-span">
     <span style="color:#4CC9F0">
      Consumir matrices Numpy
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-generadores-de-python-span">
     <span style="color:#4CC9F0">
      Consumir generadores de Python
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-ejemplo-realista-con-imagenes-span">
     <span style="color:#4CC9F0">
      Ejemplo realista con imágenes
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-datos-de-texto-span">
     <span style="color:#4CC9F0">
      Consumir datos de texto
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-datos-csv-span">
     <span style="color:#4CC9F0">
      Consumir datos CSV
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-consumir-conjuntos-de-archivos-span">
     <span style="color:#4CC9F0">
      Consumir conjuntos de archivos
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-loteo-de-elementos-del-dataset-span">
   <span style="color:#4361EE">
    Loteo de elementos del dataset
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-loteo-simple-span">
     <span style="color:#4CC9F0">
      Loteo simple
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-loteo-de-tensores-con-acolchamiento-span">
     <span style="color:#4CC9F0">
      Loteo de tensores con acolchamiento
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-flujo-de-entrenamiento-span">
   <span style="color:#4361EE">
    Flujo de entrenamiento
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-procesando-multiples-epochs-span">
     <span style="color:#4CC9F0">
      Procesando múltiples epochs
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-mezclar-los-dato-de-entrada-span">
   <span style="color:#4361EE">
    Mezclar los dato de entrada
   </span>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-preprocesamiento-de-datos-span">
   <span style="color:#4361EE">
    Preprocesamiento de datos
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-decodificando-imagenes-y-cambiar-su-tamano-span">
     <span style="color:#4CC9F0">
      Decodificando imagenes y cambiar su tamaño
     </span>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-aplicando-funciones-de-python-span">
     <span style="color:#4CC9F0">
      Aplicando funciones de Python
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ventaneo-de-series-de-tiempo">
   Ventaneo De series de tiempo
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-remuestreo-span">
   <span style="color:#4361EE">
    Remuestreo
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#span-style-color-4cc9f0-muestreo-de-datasets-span">
     <span style="color:#4CC9F0">
      Muestreo de Datasets
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-color-4361ee-remuestreo-de-rechazo-span">
   <span style="color:#4361EE">
    Remuestreo de rechazo
   </span>
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="span-style-color-f72585-canalizacion-de-datos-la-api-tf-data-span">
<h1><span style="color:#F72585">Canalización de datos. La API tf.data</span><a class="headerlink" href="#span-style-color-f72585-canalizacion-de-datos-la-api-tf-data-span" title="Permalink to this headline">#</a></h1>
<section id="span-style-color-4361ee-introduccion-span">
<h2><span style="color:#4361EE">Introducción</span><a class="headerlink" href="#span-style-color-4361ee-introduccion-span" title="Permalink to this headline">#</a></h2>
<p>Basado en <a class="reference external" href="https://www.tensorflow.org/guide/data">tf.data</a>.</p>
<p>La API <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> permite crear tuberías de entrada complejas a partir de piezas simples y reutilizables. Por ejemplo, la canalización de un modelo de imagen podría agregar datos de archivos en un sistema de archivos distribuido, aplicar perturbaciones aleatorias a cada imagen y fusionar imágenes seleccionadas al azar en un lote para entrenamiento. La canalización de un modelo de texto puede implicar extraer símbolos de datos de texto sin procesar, convertirlos en identificadores incrustados con una tabla de búsqueda y agrupar secuencias de diferentes longitudes.</p>
</section>
<section id="span-style-color-4361ee-importa-librerias-span">
<h2><span style="color:#4361EE">Importa librerías</span><a class="headerlink" href="#span-style-color-4361ee-importa-librerias-span" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-29 04:22:10.459522: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2022-08-29 04:22:10.459555: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4361ee-esenciales-span">
<h2><span style="color:#4361EE">Esenciales</span><a class="headerlink" href="#span-style-color-4361ee-esenciales-span" title="Permalink to this headline">#</a></h2>
<p>Para crear una canalización de entrada, debe comenzar con una fuente de datos. Por ejemplo, para construir un <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> de datos a partir de datos en la memoria, puede usar <em>tf.data.Dataset.from_tensors()</em> o <em>tf.data.Dataset.from_tensor_slices()</em>. Alternativamente, si sus datos de entrada están almacenados en un archivo en el formato <em>TFRecord</em> de TensorFlow puede usar <em>tf.data.TFRecordDataset()</em>.</p>
<p>El objeto Dataset es un iterable de Python. Esto hace posible consumir sus elementos usando un bucle for:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-29 04:22:13.719236: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcuda.so.1&#39;; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory
2022-08-29 04:22:13.719272: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-08-29 04:22:13.719296: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (fv-az154-957): /proc/driver/nvidia/version does not exist
2022-08-29 04:22:13.719610: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TensorSliceDataset element_spec=TensorSpec(shape=(), dtype=tf.int32, name=None)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
3
0
8
2
1
</pre></div>
</div>
</div>
</div>
<p>o se pueden crear explícitamente un iterador</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
3
</pre></div>
</div>
</div>
</div>
<section id="consumo-de-datos-usando-reduccion-reduce">
<h3>Consumo de datos usando reducción: reduce<a class="headerlink" href="#consumo-de-datos-usando-reduccion-reduce" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">state</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">state</span><span class="o">+</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>22
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-4361ee-estructura-del-conjunto-de-datos-span">
<h2><span style="color:#4361EE">Estructura del conjunto de datos</span><a class="headerlink" href="#span-style-color-4361ee-estructura-del-conjunto-de-datos-span" title="Permalink to this headline">#</a></h2>
<p>Un conjunto de datos produce una secuencia de elementos , donde cada elemento tiene la misma estructura (anidada) de componentes .</p>
<p>Los componentes individuales de la estructura pueden ser de cualquier tipo representable por <em>tf.TypeSpec</em>, incluidos <em>tf.Tensor</em> , <em>tf.sparse.SparseTensor</em> ,<em>tf.RaggedTensor</em> , <em>tf.TensorArray</em> o <em>tf.data.Dataset</em>.</p>
<p>Las construcciones de Python que se pueden usar para expresar la estructura (anidada) de elementos incluyen <em>tuple , dict , NamedTuple y OrderedDict</em>.</p>
<p>En particular, <em>list</em> no es una construcción válida para expresar la estructura de los elementos del conjunto de datos.</p>
<p>Si desea que una entrada de <em>list</em> se trate como una estructura, debe convertirla en tuple y si desea que una lista de salida, entonces debe empaquetarla explícitamente usando <em>tf.stack</em>.</p>
<p>La propiedad <em>Dataset.element_spec</em> permite inspeccionar el tipo de cada componente del elemento. La propiedad devuelve una estructura anidada de objetos <em>tf.TypeSpec</em>, que coincide con la estructura del elemento, que puede ser un solo componente, una tupla de componentes o una tupla anidada de componentes. Por ejemplo:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TensorSliceDataset element_spec=TensorSpec(shape=(10,), dtype=tf.float32, name=None)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataset1</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.3361 0.4547 0.4914 0.7589 0.807  0.4934 0.501  0.5252 0.6555 0.7433]
[0.8791 0.2255 0.7518 0.7439 0.3829 0.8556 0.2929 0.5411 0.6318 0.029 ]
[0.6104 0.922  0.5009 0.296  0.5441 0.2815 0.9348 0.3654 0.2356 0.5149]
[0.4265 0.833  0.2675 0.403  0.3523 0.8006 0.7316 0.8646 0.129  0.6385]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">dataset1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span>
    <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">4</span><span class="p">]),</span> <span class="c1">#y</span>
     <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)))</span> <span class="c1">#x</span>

<span class="n">dataset2</span><span class="o">.</span><span class="n">element_spec</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(TensorSpec(shape=(), dtype=tf.float32, name=None),
 TensorSpec(shape=(100,), dtype=tf.int32, name=None))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">dataset2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">dataset1</span><span class="p">,</span> <span class="n">dataset2</span><span class="p">))</span>
<span class="n">dataset3</span><span class="o">.</span><span class="n">element_spec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(TensorSpec(shape=(10,), dtype=tf.float32, name=None),
 (TensorSpec(shape=(), dtype=tf.float32, name=None),
  TensorSpec(shape=(100,), dtype=tf.int32, name=None)))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">dataset3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">dataset3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensorflow.python.data.ops.dataset_ops.ZipDataset
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">dataset3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;tf.Tensor: shape=(10,), dtype=float32, numpy=
array([0.3361, 0.4547, 0.4914, 0.7589, 0.807 , 0.4934, 0.501 , 0.5252,
       0.6555, 0.7433], dtype=float32)&gt;, (&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.2808082&gt;, &lt;tf.Tensor: shape=(100,), dtype=int32, numpy=
array([43, 65, 65, 71, 44, 84, 47, 24, 51, 74, 87, 30, 11,  7, 52, 26, 85,
        6, 22, 89, 57, 94, 27, 55,  9, 72, 81, 11, 81, 47, 41, 75, 58, 47,
       27, 59, 91,  2, 27, 31, 29, 43, 88, 76, 15, 27, 68, 88, 48, 42, 56,
       16, 34,  7, 49, 64, 33, 57, 35, 88, 15, 16, 73, 25, 28, 34, 18, 31,
       94, 60, 56, 16, 91, 35, 12, 47, 39, 46, 32, 86, 30, 70, 63, 76, 19,
       62,  4, 37, 80, 30, 36, 32, 73, 44, 16, 27, 63, 22, 49, 61],
      dtype=int32)&gt;)) 

(&lt;tf.Tensor: shape=(10,), dtype=float32, numpy=
array([0.8791, 0.2255, 0.7518, 0.7439, 0.3829, 0.8556, 0.2929, 0.5411,
       0.6318, 0.029 ], dtype=float32)&gt;, (&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.84260666&gt;, &lt;tf.Tensor: shape=(100,), dtype=int32, numpy=
array([ 1, 74,  8, 89, 14, 65, 91,  1, 72,  0, 36, 49,  0, 98, 50, 84, 36,
       61, 78, 13, 44, 72, 69, 20,  1, 23, 61, 30, 81, 65, 84, 50, 11, 11,
       39, 73, 73, 89, 34, 27, 49, 87, 22, 83, 95,  5, 15, 16, 91,  8, 21,
       65, 26, 36, 43, 89, 90, 40, 73, 65, 96, 85, 66, 76, 17, 20, 14, 22,
       53, 55,  6, 40, 82, 44, 82, 26, 85,  0,  4,  3, 54, 82, 41, 31,  4,
        9,  9, 34, 61, 83, 50, 74, 48, 66, 84, 96, 81, 24, 32, 21],
      dtype=int32)&gt;)) 

(&lt;tf.Tensor: shape=(10,), dtype=float32, numpy=
array([0.6104, 0.922 , 0.5009, 0.296 , 0.5441, 0.2815, 0.9348, 0.3654,
       0.2356, 0.5149], dtype=float32)&gt;, (&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.859661&gt;, &lt;tf.Tensor: shape=(100,), dtype=int32, numpy=
array([49, 50, 66, 32,  9, 68, 25, 53,  0, 26, 87, 69, 89,  9, 11, 70, 95,
        9, 81, 49, 35, 58, 15, 92, 99, 22, 70, 49, 54, 80, 25, 40, 96, 53,
       23,  9, 86, 29, 87, 90, 21, 15,  1, 79, 59, 78, 58, 99, 44, 63, 27,
       19, 54, 99, 15, 69, 94, 65, 83, 46, 87, 58, 60, 27, 95, 17, 65, 26,
       22,  2, 48, 97,  4, 72, 10, 99, 41, 83, 62, 91, 52, 84, 65, 82, 92,
       45, 98,  0, 25, 60, 14, 48, 62, 34, 68, 56, 31, 79, 32, 39],
      dtype=int32)&gt;)) 

(&lt;tf.Tensor: shape=(10,), dtype=float32, numpy=
array([0.4265, 0.833 , 0.2675, 0.403 , 0.3523, 0.8006, 0.7316, 0.8646,
       0.129 , 0.6385], dtype=float32)&gt;, (&lt;tf.Tensor: shape=(), dtype=float32, numpy=0.776299&gt;, &lt;tf.Tensor: shape=(100,), dtype=int32, numpy=
array([ 0, 95, 31, 64, 75, 19, 20, 67, 80, 57, 35, 40, 30, 84,  2, 38, 76,
       65,  0, 35, 67, 86, 11, 79, 17, 53, 73, 62, 51, 97, 90, 76, 88, 50,
       73, 43, 28, 43,  8, 56, 87, 80, 62, 73, 88, 47, 55, 94, 40, 34,  1,
       83, 89, 89, 26, 35, 65, 25, 49, 53, 71, 28, 65, 70, 88, 82, 58, 89,
       38, 53,  4, 89, 53, 25, 62, 51, 23, 39, 19, 66,  7, 70, 55, 84, 25,
       42, 51, 56, 32, 87, 42,  2, 24, 68, 92, 23, 73, 22,  0, 29],
      dtype=int32)&gt;)) 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dataset3</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shapes: </span><span class="si">{a.shape}</span><span class="s1">, </span><span class="si">{b.shape}</span><span class="s1">, </span><span class="si">{c.shape}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>shapes: (10,), (), (100,)
shapes: (10,), (), (100,)
shapes: (10,), (), (100,)
shapes: (10,), (), (100,)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-29 04:22:13.928902: W tensorflow/core/data/root_dataset.cc:247] Optimization loop failed: CANCELLED: Operation was cancelled
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset con tensores dispersos</span>
<span class="n">dataset4</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensors</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
<span class="n">dataset4</span><span class="o">.</span><span class="n">element_spec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SparseTensorSpec(TensorShape([3, 4]), tf.int32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset4</span><span class="o">.</span><span class="n">element_spec</span><span class="o">.</span><span class="n">value_type</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tensorflow.python.framework.sparse_tensor.SparseTensor
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4361ee-leer-datos-de-entrada-span">
<h2><span style="color:#4361EE">Leer datos de entrada</span><a class="headerlink" href="#span-style-color-4361ee-leer-datos-de-entrada-span" title="Permalink to this headline">#</a></h2>
<section id="span-style-color-4cc9f0-consumir-matrices-numpy-span">
<h3><span style="color:#4CC9F0">Consumir matrices Numpy</span><a class="headerlink" href="#span-style-color-4cc9f0-consumir-matrices-numpy-span" title="Permalink to this headline">#</a></h3>
<p>Si todos sus datos de entrada caben en la memoria, la forma más sencilla de crear un Dataset a partir de ellos es convertirlos en objetos tf.Tensor y usar Dataset.from_tensor_slices() .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-labels-idx1-ubyte.gz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 8192/29515 [=======&gt;......................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
29515/29515 [==============================] - 0s 0us/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/train-images-idx3-ubyte.gz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    8192/26421880 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
12394496/26421880 [=============&gt;................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
26421880/26421880 [==============================] - 0s 0us/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-labels-idx1-ubyte.gz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5148/5148 [==============================] - 0s 0us/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/tf-keras-datasets/t10k-images-idx3-ubyte.gz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   8192/4422102 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
4422102/4422102 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imagenes</span><span class="p">,</span> <span class="n">labels</span>  <span class="o">=</span> <span class="n">train</span>
<span class="n">imagenes</span> <span class="o">=</span> <span class="n">imagenes</span> <span class="o">/</span><span class="mf">255.</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">imagenes</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
<span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-29 04:22:14.782239: W tensorflow/core/framework/cpu_allocator_impl.cc:82] Allocation of 376320000 exceeds 10% of free system memory.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TensorSliceDataset element_spec=(TensorSpec(shape=(28, 28), dtype=tf.float64, name=None), TensorSpec(shape=(), dtype=tf.uint8, name=None))&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-consumir-generadores-de-python-span">
<h3><span style="color:#4CC9F0">Consumir generadores de Python</span><a class="headerlink" href="#span-style-color-4cc9f0-consumir-generadores-de-python-span" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">stop</span><span class="p">):</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">stop</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="n">i</span><span class="o">+=</span> <span class="mi">1</span>
        
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">count</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
1
2
3
4
</pre></div>
</div>
</div>
</div>
<p>El constructor <code class="docutils literal notranslate"><span class="pre">Dataset.from_generator</span></code> convierte el generador de Python en un <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> completamente funcional.</p>
<p>El constructor toma un invocable como entrada, no un iterador. Esto le permite reiniciar el generador cuando llega al final. Toma un argumento args opcional, que se pasa como argumentos del invocable.</p>
<p>El argumento <em>output_types</em> es necesario porque <em>tf.data</em> crea un <em>tf.Graph</em> internamente y los bordes del gráfico requieren un tf.dtype .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">output_types</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">output_shapes</span><span class="o">=</span><span class="p">(),)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">count_batch</span> <span class="ow">in</span> <span class="n">ds_counter</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">count_batch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2 3 4 5 6 7 8 9]
[10 11 12 13 14 15 16 17 18 19]
[20 21 22 23 24  0  1  2  3  4]
[ 5  6  7  8  9 10 11 12 13 14]
[15 16 17 18 19 20 21 22 23 24]
[0 1 2 3 4 5 6 7 8 9]
[10 11 12 13 14 15 16 17 18 19]
[20 21 22 23 24  0  1  2  3  4]
[ 5  6  7  8  9 10 11 12 13 14]
[15 16 17 18 19 20 21 22 23 24]
</pre></div>
</div>
</div>
</div>
<p>El argumento <code class="docutils literal notranslate"><span class="pre">output_shapes</span></code> no es necesario, pero se recomienda, ya que muchas operaciones de flujo tensorial no admiten tensores con rango desconocido. Si la longitud de un eje en particular es desconocida o variable, output_shapes puede colcarse como None.</p>
<p>También es importante tener en cuenta que <code class="docutils literal notranslate"><span class="pre">output_shapes</span></code> y <code class="docutils literal notranslate"><span class="pre">output_types</span></code> siguen las mismas reglas de anidamiento que otros métodos de conjuntos de datos.</p>
<p>Aquí hay un generador de ejemplo que demuestra ambos aspectos, devuelve tuplas de matrices, donde la segunda matriz es un vector con longitud desconocida.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_series</span><span class="p">():</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span><span class="p">,))</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">gen_series</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">series</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 : [ 0.6296 -0.0301 -0.7554 -0.132  -0.4814 -1.4165  1.8596]
1 : [-0.6837 -0.2918  0.6383 -1.2091 -0.4444]
2 : [-0.562]
3 : [-0.3526 -0.6267  0.1356]
4 : [ 1.9022  0.2085 -1.5335  1.8058 -0.4661  1.5627 -0.0444 -0.4056 -0.6086]
5 : [ 0.7598 -0.0671 -1.119   0.3256 -0.2573]
6 : [0.1974]
</pre></div>
</div>
</div>
</div>
<p>La primera salida es un <em>int32</em> la segunda es un <em>float32</em>.</p>
<p>El primer elemento es un escalar, forma () , y el segundo es un vector de longitud desconocida, forma (None,)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_series</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span>
    <span class="n">gen_series</span><span class="p">,</span>
    <span class="n">output_types</span><span class="o">=</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">output_shapes</span><span class="o">=</span><span class="p">((),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">)))</span>

<span class="n">ds_series</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;FlatMapDataset element_spec=(TensorSpec(shape=(), dtype=tf.int32, name=None), TensorSpec(shape=(None,), dtype=tf.float32, name=None))&gt;
</pre></div>
</div>
</div>
</div>
<p>Ahora se puede utilizar como un <em>tf.data.Dataset</em> normal. Tenga en cuenta que al procesar por lotes un conjunto de datos con una forma variable, debe usar <em>Dataset.padded_batch</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_series_batch</span> <span class="o">=</span> <span class="n">ds_series</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">padded_batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ids</span><span class="p">,</span> <span class="n">sequence_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">ds_series_batch</span><span class="p">))</span>

<span class="nb">print</span> <span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sequence_batch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[14  5 11 19 16  6  8 13 17 20]

[[-1.8584  0.0246  0.2238 -0.2737 -0.5885  0.9198 -0.4713 -0.4671  1.7358]
 [-0.191   0.2231 -0.5829  0.8018 -0.3141 -0.9909 -0.3015  0.      0.    ]
 [ 1.4635 -1.6087  0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.3018 -0.8111 -0.3486  2.3088 -0.2418  0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-1.8841 -1.4659 -0.7021  0.6785 -0.3281 -1.1807 -2.5213 -1.389   0.    ]
 [-0.2647  1.3234  0.8281 -0.3461 -0.7835  0.6617 -1.2273  0.      0.    ]
 [ 0.9491  0.1513  0.2064  0.      0.      0.      0.      0.      0.    ]
 [ 0.8449  0.6879  0.      0.      0.      0.      0.      0.      0.    ]
 [-0.4935  1.2985 -0.4185  0.2856  0.826   2.4773  2.2774  0.      0.    ]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ds_series_batch</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">ids</span><span class="p">,</span> <span class="n">sequence_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sequence_batch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>
    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 5  8  4  9 11  0  2  6 19 22]

[[ 0.1837 -0.5755  0.3212  0.2094 -1.3808  0.      0.      0.      0.    ]
 [ 0.2239  1.985  -1.3608 -1.8035 -0.9517 -0.9706 -0.8671  0.      0.    ]
 [-0.7418 -0.5955 -1.4847 -0.4236  1.3719  0.6742  1.34   -0.551   0.0258]
 [-0.0584 -0.9194  0.4311  0.3312 -3.1612  0.6834  0.8455  0.      0.    ]
 [ 0.0749 -1.0675  0.1016  0.9704 -0.9456 -0.0034 -0.6325  0.      0.    ]
 [-0.2274  0.4172  1.6642  2.7158 -1.2042  0.2989 -0.6418  0.9001  0.9191]
 [-1.287   0.8316  0.627   0.1701 -1.1151  0.8596  1.1545 -2.4304 -0.036 ]
 [ 1.1509  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.378  -0.0306  2.0165 -1.4437  1.6162  0.557   0.      0.      0.    ]
 [ 0.9645  0.      0.      0.      0.      0.      0.      0.      0.    ]]

[17  3 28 29 15  1  7 36 26 13]

[[ 0.3235  0.3159 -0.2705  0.1733  1.0849  0.6899  0.      0.      0.    ]
 [ 0.3433  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-1.094   1.449   0.7191 -0.9924 -0.4457 -0.3655  1.0137  0.      0.    ]
 [-0.8011 -0.0423  0.0992 -0.4693 -0.9051 -0.3283  0.8242 -1.4604  0.    ]
 [-1.5965 -0.0491  0.7587 -0.2185  0.8017  0.8549 -1.273  -1.7912 -0.3007]
 [ 0.0616 -0.7124  0.      0.      0.      0.      0.      0.      0.    ]
 [-0.7266 -1.0517 -1.0051  1.0671 -1.4304 -0.0107  1.1984  0.5976  0.    ]
 [-0.5457 -1.5415 -1.0172 -0.1476  1.4521  0.4276  0.4659  1.3222  0.    ]
 [ 0.5251 -0.5196 -0.0594  0.6504 -1.6037 -0.8096 -0.9782  0.5761 -2.3527]
 [ 1.1089 -0.0803  1.9036 -0.2408  0.      0.      0.      0.      0.    ]]

[38 25 34 37 23 20 27 14 33 21]

[[-0.0926 -0.8275  0.3214  0.7626  0.      0.      0.      0.      0.    ]
 [-0.2723 -0.3398 -0.3938  0.3394 -1.9923 -1.4698 -2.1671 -1.0376 -0.1732]
 [ 1.5368  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.2968 -0.3457 -0.9619 -0.9502  0.      0.      0.      0.      0.    ]
 [-0.6562 -0.0684  0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-0.1217 -0.5706 -0.7769 -1.1498  1.0876 -0.6062 -0.1353 -0.3025 -0.8093]
 [ 2.6607 -0.6035  0.1047 -0.456   0.7399  2.4811  0.      0.      0.    ]
 [-0.1228  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [ 1.9825 -1.6799 -0.1828  1.708  -2.0869  1.0287  0.0083 -0.0944  0.    ]]

[44 49 39 47 43 10 51 55 35 53]

[[ 0.7907  2.0739  0.4973  1.5835  0.6206 -1.6427  1.8236 -1.3525 -1.1285]
 [-0.5728 -0.7956  0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.0336  1.2399  0.3644  0.0363  0.3063 -0.2965 -1.2529 -0.2835  0.    ]
 [ 0.9654  0.1868  0.      0.      0.      0.      0.      0.      0.    ]
 [-0.0866 -1.0913 -0.7305  0.862   0.9275  0.      0.      0.      0.    ]
 [ 1.5106 -0.9771 -1.7088  1.486   0.1922 -1.3976  0.7693  0.      0.    ]
 [ 0.4084  1.3775  0.4779 -1.036  -0.1236 -1.9134  0.973   0.      0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.7245 -1.034  -0.2913 -0.7208  2.0867  0.1981  0.      0.      0.    ]
 [-2.6505  2.6849 -1.444  -1.1894 -1.0911 -0.5067  0.      0.      0.    ]]

[48 42 60 18 40 63 62 12 31 65]

[[ 0.7965 -0.3324  0.6106 -1.9561  0.      0.      0.      0.      0.    ]
 [-0.2559 -0.0468 -0.9818 -0.6221  0.0157  0.3206  0.0656 -1.3256  0.    ]
 [-1.3302  0.0214 -0.3952  0.      0.      0.      0.      0.      0.    ]
 [ 0.6435 -0.6769  0.      0.      0.      0.      0.      0.      0.    ]
 [-1.7593  0.0942 -0.9556 -0.9199  0.      0.      0.      0.      0.    ]
 [ 0.6009 -0.8563  0.3499  0.4512 -1.77   -0.2719 -0.8768 -0.2484  0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-0.0959  0.1559 -0.3145 -1.6448 -0.4214 -1.0411  1.1474 -0.7295  1.0394]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-1.4094  0.1043  0.      0.      0.      0.      0.      0.      0.    ]]

[57 50 71 59 32 56 61 64 77 78]

[[-0.1471  0.9597  0.769   0.0128 -0.4686 -0.553   0.841   0.      0.    ]
 [ 0.4795  0.2911 -0.8276  1.1286 -1.1912  0.1774 -1.2854 -1.0988  0.4163]
 [-0.4922  1.3174  0.5244 -1.5742  2.0226 -0.8375 -0.0031  0.      0.    ]
 [ 1.3522  0.3876  0.3084 -0.1566 -0.2631  0.      0.      0.      0.    ]
 [ 0.2534  0.1309 -0.7062  0.      0.      0.      0.      0.      0.    ]
 [ 0.7187  0.129   0.      0.      0.      0.      0.      0.      0.    ]
 [-0.15    0.3359  0.1562  1.9625 -1.3952  0.      0.      0.      0.    ]
 [-0.1438 -1.433  -2.1333  0.2204 -0.6321 -0.3095 -1.3742  0.5066  0.    ]
 [-0.3775 -0.2715  0.      0.      0.      0.      0.      0.      0.    ]
 [-2.3839 -0.3751  0.674   0.      0.      0.      0.      0.      0.    ]]

[30 69 68 80 67 54 74 81 76 66]

[[ 0.1957 -0.998   0.9893 -0.1383  1.3615  0.      0.      0.      0.    ]
 [ 0.8084 -0.4005 -1.4583  1.323   0.      0.      0.      0.      0.    ]
 [-1.4462  1.4674 -0.442   0.02    0.8779 -1.1316  0.905  -0.3029  0.    ]
 [ 0.      0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-0.3135  0.0703  0.689  -1.7183  0.2089 -0.5237 -0.6466  1.0611 -1.9811]
 [ 0.1209  0.5786  0.4306 -1.8235  0.8825 -1.6657 -0.0505 -0.2468 -0.7857]
 [ 0.8582  0.3113  1.4247 -0.0358  1.8887  0.      0.      0.      0.    ]
 [-1.1021 -0.5408  0.0446  1.4346  0.1746  0.1259  0.1526  1.1918  0.7636]
 [-1.9481 -0.6392 -0.2857  1.248   1.1692  0.      0.      0.      0.    ]
 [ 0.9884  1.8805 -0.2981 -0.9553  0.9759  0.3188  0.0445 -0.3113  0.    ]]

[70 75 79 24 16 82 46 95 86 72]

[[-1.0037  0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.0335  1.1082 -0.656   1.2438 -0.9688  0.      0.      0.    ]
 [ 0.377  -0.3172  0.      0.      0.      0.      0.      0.    ]
 [ 0.1787 -1.2656  0.9164 -0.8868 -0.5694  0.      0.      0.    ]
 [-0.3599 -0.6505 -0.3877 -1.9351 -0.2709  0.      0.      0.    ]
 [ 0.5426 -0.2732 -1.2955  0.0981  0.8679 -2.1593  1.0511  0.6754]
 [-0.3613 -0.3679  0.      0.      0.      0.      0.      0.    ]
 [-0.189   0.4959 -1.297  -0.3976 -0.2886 -0.6216 -0.1513  0.    ]
 [ 0.6237  0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.596   0.      0.      0.      0.      0.      0.      0.    ]]

[ 92  85  96  73  58  84  52  41 106 101]

[[-0.9764 -1.8764  1.0723 -1.5269  2.7191  0.9633 -0.6209  0.3205 -0.5264]
 [-0.1271 -1.9159 -1.1399 -0.3922  0.3783 -2.4311  0.5343  0.227   0.    ]
 [-1.1976 -1.7263  0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.9885  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [ 0.2204 -0.1171 -0.166   1.0976 -0.0192  0.8402 -1.3247  0.      0.    ]
 [ 1.1898 -0.0667 -0.1512 -0.0708 -0.4274 -0.3834  0.1196  0.3888  0.4409]
 [ 0.1801 -0.7755  1.2533  0.0281  0.7164 -0.0878  0.      0.      0.    ]
 [-0.0175  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-1.2611  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-0.8186  0.6217 -1.2305 -0.4606  2.639  -0.5861  0.      0.      0.    ]]

[ 87 103 105  89  45  97 112 113 107  99]

[[-1.8538 -0.148   0.8828  1.7411  1.1557 -0.4526  0.      0.      0.    ]
 [-0.5487 -1.2206 -1.3705  0.7662 -0.3069  0.0824 -0.819  -0.7303 -1.6394]
 [-0.178   1.3247  0.075  -0.477   0.1271 -0.1196 -0.4929  0.      0.    ]
 [ 1.1675  1.5596 -1.2643 -1.4213 -0.113   0.3912  0.3804  0.      0.    ]
 [-0.1383  0.5491 -0.4266  0.5055  1.0807 -0.4322  0.4191 -0.0048 -1.6782]
 [-1.2615  0.2532  0.1474  0.6451  2.9426  0.      0.      0.      0.    ]
 [-2.0655  1.0177  0.      0.      0.      0.      0.      0.      0.    ]
 [-1.0582  0.      0.      0.      0.      0.      0.      0.      0.    ]
 [-0.6613 -0.8785  1.0063  0.      0.      0.      0.      0.      0.    ]
 [ 1.5675 -1.0414  0.3655 -1.6478  0.2756  0.      0.      0.      0.    ]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-ejemplo-realista-con-imagenes-span">
<h3><span style="color:#4CC9F0">Ejemplo realista con imágenes</span><a class="headerlink" href="#span-style-color-4cc9f0-ejemplo-realista-con-imagenes-span" title="Permalink to this headline">#</a></h3>
<p>Para obtener un ejemplo más realista, intente <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> <code class="docutils literal notranslate"><span class="pre">preprocessing.image.ImageDataGenerator</span></code> como un <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> .</p>
<p>Primero descargue los datos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flowers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s1">&#39;flower_photos&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz&#39;</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;/media/storage&#39;</span><span class="p">,</span> <span class="c1">#dirección de extracción</span>
    <span class="n">cache_subdir</span><span class="o">=</span><span class="s1">&#39;Datasets&#39;</span><span class="p">,</span> <span class="c1">#carpeta que se crea para la extracción</span>
    <span class="n">untar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     8192/228813984 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
  8396800/228813984 [&gt;.............................] - ETA: 1s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 21716992/228813984 [=&gt;............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 37101568/228813984 [===&gt;..........................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 52420608/228813984 [=====&gt;........................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 67878912/228813984 [=======&gt;......................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 83165184/228813984 [=========&gt;....................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 98729984/228813984 [===========&gt;..................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
114384896/228813984 [=============&gt;................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
130023424/228813984 [================&gt;.............] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
145399808/228813984 [==================&gt;...........] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
160997376/228813984 [====================&gt;.........] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
176480256/228813984 [======================&gt;.......] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
191905792/228813984 [========================&gt;.....] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
207085568/228813984 [==========================&gt;...] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
222208000/228813984 [============================&gt;.] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
228813984/228813984 [==============================] - 1s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">flowers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/.keras/Datasets/flower_photos
</pre></div>
</div>
</div>
</div>
<p>Cree la <code class="docutils literal notranslate"><span class="pre">image.ImageDataGenerator</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_gen</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="n">rotation_range</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">image_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">flowers</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 3670 images belonging to 5 classes.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float32 (32, 256, 256, 3)
float32 (32, 5)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="n">image_gen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">flowers</span><span class="p">),</span>
    <span class="n">output_types</span><span class="o">=</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">output_shapes</span><span class="o">=</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">32</span><span class="p">,</span><span class="mi">5</span><span class="p">]))</span>

<span class="n">ds</span><span class="o">.</span><span class="n">element_spec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(TensorSpec(shape=(32, 256, 256, 3), dtype=tf.float32, name=None),
 TensorSpec(shape=(32, 5), dtype=tf.float32, name=None))
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-consumir-datos-de-texto-span">
<h3><span style="color:#4CC9F0">Consumir datos de texto</span><a class="headerlink" href="#span-style-color-4cc9f0-consumir-datos-de-texto-span" title="Permalink to this headline">#</a></h3>
<p>Muchos conjuntos de datos se distribuyen como uno o más archivos de texto. <code class="docutils literal notranslate"><span class="pre">tf.data.TextLineDataset</span></code> proporciona una manera fácil de extraer líneas de uno o más archivos de texto.</p>
<p>Dados uno o más nombres de archivo, un <code class="docutils literal notranslate"><span class="pre">TextLineDataset</span></code> producirá un elemento con valor de cadena por línea de esos archivos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">directory_url</span> <span class="o">=</span> <span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/data/illiad/&#39;</span>
<span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cowper.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;derby.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;butler.txt&#39;</span><span class="p">]</span>

<span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">directory_url</span> <span class="o">+</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_names</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/download.tensorflow.org/data/illiad/cowper.txt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8192/815980 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
815980/815980 [==============================] - 0s 0us/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/download.tensorflow.org/data/illiad/derby.txt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8192/809730 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
809730/809730 [==============================] - 0s 0us/step
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/download.tensorflow.org/data/illiad/butler.txt
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8192/807992 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
807992/807992 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file_paths</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/home/runner/.keras/datasets/cowper.txt&#39;,
 &#39;/home/runner/.keras/datasets/derby.txt&#39;,
 &#39;/home/runner/.keras/datasets/butler.txt&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Estas son las primeras líneas del primer archivo:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&quot;\xef\xbb\xbfAchilles sing, O Goddess! Peleus&#39; son;&quot;
b&#39;His wrath pernicious, who ten thousand woes&#39;
b&quot;Caused to Achaia&#39;s host, sent many a soul&quot;
b&#39;Illustrious into Ades premature,&#39;
b&#39;And Heroes gave (so stood the will of Jove)&#39;
</pre></div>
</div>
</div>
</div>
<p>Para alternar líneas entre archivos, use <code class="docutils literal notranslate"><span class="pre">Dataset.interleave</span></code> . Esto facilita la reproducción aleatoria de archivos. Aquí están la primera, segunda y tercera líneas de cada traducción:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">file_ds</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&#39;/home/runner/.keras/datasets/cowper.txt&#39;
b&#39;/home/runner/.keras/datasets/derby.txt&#39;
b&#39;/home/runner/.keras/datasets/butler.txt&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">line_ds</span> <span class="o">=</span> <span class="n">file_ds</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">,</span> <span class="n">cycle_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">9</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="k">3</span> ==0:
        <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&quot;\xef\xbb\xbfAchilles sing, O Goddess! Peleus&#39; son;&quot;
b&quot;\xef\xbb\xbfOf Peleus&#39; son, Achilles, sing, O Muse,&quot;
b&#39;\xef\xbb\xbfSing, O goddess, the anger of Achilles son of Peleus, that brought&#39;

b&#39;His wrath pernicious, who ten thousand woes&#39;
b&#39;The vengeance, deep and deadly; whence to Greece&#39;
b&#39;countless ills upon the Achaeans. Many a brave soul did it send&#39;

b&quot;Caused to Achaia&#39;s host, sent many a soul&quot;
b&#39;Unnumbered ills arose; which many a soul&#39;
b&#39;hurrying down to Hades, and many a hero did it yield a prey to dogs and&#39;
</pre></div>
</div>
</div>
</div>
<p>De manera predeterminada, <code class="docutils literal notranslate"><span class="pre">TextLineDataset</span></code> produce todas las lineas de cada archivo, lo cual tal vez no sea lo que se quiera. Tal vez el archivo empieza con el encabezado, o contiene comentarios. Para remover o pasarse estas lineas se usan las transformaciones <code class="docutils literal notranslate"><span class="pre">Dataset.skip()</span></code> o <code class="docutils literal notranslate"><span class="pre">Dataset.filter()</span></code></p>
<p>A continuación, trabajamos con el archivo de la tragedia del Titanic. Se salta la primera linea, y filtramos para tener solo a los sobrevivientes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_file</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s2">&quot;train.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;https://storage.googleapis.com/tf-datasets/titanic/train.csv&quot;</span><span class="p">)</span>
<span class="n">titanic_lines</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">titanic_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tf-datasets/titanic/train.csv
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 8192/30874 [======&gt;.......................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
30874/30874 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">titanic_lines</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&#39;survived,sex,age,n_siblings_spouses,parch,fare,class,deck,embark_town,alone&#39;
b&#39;0,male,22.0,1,0,7.25,Third,unknown,Southampton,n&#39;
b&#39;1,female,38.0,1,0,71.2833,First,C,Cherbourg,n&#39;
b&#39;1,female,26.0,0,0,7.925,Third,unknown,Southampton,y&#39;
b&#39;1,female,35.0,1,0,53.1,First,C,Southampton,n&#39;
b&#39;0,male,28.0,0,0,8.4583,Third,unknown,Queenstown,y&#39;
b&#39;0,male,2.0,3,1,21.075,Third,unknown,Southampton,n&#39;
b&#39;1,female,27.0,0,2,11.1333,Third,unknown,Southampton,n&#39;
b&#39;1,female,14.0,1,0,30.0708,Second,unknown,Cherbourg,n&#39;
b&#39;1,female,4.0,1,1,16.7,Third,G,Southampton,n&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">survived</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">substr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

<span class="n">survivors</span><span class="o">=</span><span class="n">titanic_lines</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">survived</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">survivors</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&#39;1,female,38.0,1,0,71.2833,First,C,Cherbourg,n&#39;
b&#39;1,female,26.0,0,0,7.925,Third,unknown,Southampton,y&#39;
b&#39;1,female,35.0,1,0,53.1,First,C,Southampton,n&#39;
b&#39;1,female,27.0,0,2,11.1333,Third,unknown,Southampton,n&#39;
b&#39;1,female,14.0,1,0,30.0708,Second,unknown,Cherbourg,n&#39;
b&#39;1,female,4.0,1,1,16.7,Third,G,Southampton,n&#39;
b&#39;1,male,28.0,0,0,13.0,Second,unknown,Southampton,y&#39;
b&#39;1,female,28.0,0,0,7.225,Third,unknown,Cherbourg,y&#39;
b&#39;1,male,28.0,0,0,35.5,First,A,Southampton,y&#39;
b&#39;1,female,38.0,1,5,31.3875,Third,unknown,Southampton,n&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-consumir-datos-csv-span">
<h3><span style="color:#4CC9F0">Consumir datos CSV</span><a class="headerlink" href="#span-style-color-4cc9f0-consumir-datos-csv-span" title="Permalink to this headline">#</a></h3>
<p>El formato CSV es muy popular para guardar datos tabulares en forma de texto.</p>
<p>Ya subimos el archivo del titanic, el cual es csv. Podemos subirlo en este mismo formato usando pandas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">titanic_file</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>survived</th>
      <th>sex</th>
      <th>age</th>
      <th>n_siblings_spouses</th>
      <th>parch</th>
      <th>fare</th>
      <th>class</th>
      <th>deck</th>
      <th>embark_town</th>
      <th>alone</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>7.2500</td>
      <td>Third</td>
      <td>unknown</td>
      <td>Southampton</td>
      <td>n</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>71.2833</td>
      <td>First</td>
      <td>C</td>
      <td>Cherbourg</td>
      <td>n</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>7.9250</td>
      <td>Third</td>
      <td>unknown</td>
      <td>Southampton</td>
      <td>y</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>53.1000</td>
      <td>First</td>
      <td>C</td>
      <td>Southampton</td>
      <td>n</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>male</td>
      <td>28.0</td>
      <td>0</td>
      <td>0</td>
      <td>8.4583</td>
      <td>Third</td>
      <td>unknown</td>
      <td>Queenstown</td>
      <td>y</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Si se tiene suficiente memoria, pueden transformar a diccionario el Dataframe e importar los datos con facilidad</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_slices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

<span class="k">for</span> <span class="n">feature_batch</span> <span class="ow">in</span> <span class="n">titanic_slices</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">feature_batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{!r:20s}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  &#39;survived&#39;          : 0
  &#39;sex&#39;               : b&#39;male&#39;
  &#39;age&#39;               : 22.0
  &#39;n_siblings_spouses&#39;: 1
  &#39;parch&#39;             : 0
  &#39;fare&#39;              : 7.25
  &#39;class&#39;             : b&#39;Third&#39;
  &#39;deck&#39;              : b&#39;unknown&#39;
  &#39;embark_town&#39;       : b&#39;Southampton&#39;
  &#39;alone&#39;             : b&#39;n&#39;
</pre></div>
</div>
</div>
</div>
<p>Un acercamiento más ameno es cargar desde el disco cuando sea necesario.</p>
<p>el modulo tiene métodos para extraer rgistros de uno o más archivos CSV que cumplan con la <a class="reference external" href="https://tools.ietf.org/html/rfc4180">RFC 4180</a></p>
<p>la función <code class="docutils literal notranslate"><span class="pre">experimental.make_csv_dataset</span></code> es una interfaz para leer conjuntos de archivos CSV, con lo cual podemos hacer inferencia por columna y crear lotes de los datos</p>
<p>Se puede usar el argumento <code class="docutils literal notranslate"><span class="pre">select_columns</span></code> si solo se necesitan algunas columnas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_batches</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
    <span class="n">titanic_file</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">label_name</span><span class="o">=</span><span class="s2">&quot;survived&quot;</span><span class="p">,</span> <span class="n">select_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;fare&#39;</span><span class="p">,</span> <span class="s1">&#39;survived&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">feature_batch</span><span class="p">,</span> <span class="n">label_batch</span> <span class="ow">in</span> <span class="n">titanic_batches</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;survived&#39;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label_batch</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">feature_batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{!r:20s}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;survived&#39;: [1 0 0 0]
  &#39;fare&#39;              : [26.55  8.05 78.85 26.55]
  &#39;class&#39;             : [b&#39;First&#39; b&#39;Third&#39; b&#39;First&#39; b&#39;First&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-consumir-conjuntos-de-archivos-span">
<h3><span style="color:#4CC9F0">Consumir conjuntos de archivos</span><a class="headerlink" href="#span-style-color-4cc9f0-consumir-conjuntos-de-archivos-span" title="Permalink to this headline">#</a></h3>
<p>Es normal que los datos estén distribuidos en múltiples archivos, con cada archivo teniendo ejemplos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">flowers_root</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s1">&#39;flower_photos&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz&#39;</span><span class="p">,</span>
    <span class="n">untar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">flowers_root</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">flowers_root</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>     8192/228813984 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 10231808/228813984 [&gt;.............................] - ETA: 1s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 21880832/228813984 [=&gt;............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 34381824/228813984 [===&gt;..........................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 47505408/228813984 [=====&gt;........................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 61022208/228813984 [=======&gt;......................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 74211328/228813984 [========&gt;.....................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 85999616/228813984 [==========&gt;...................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
101392384/228813984 [============&gt;.................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
113909760/228813984 [=============&gt;................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
125796352/228813984 [===============&gt;..............] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
137871360/228813984 [=================&gt;............] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
150847488/228813984 [==================&gt;...........] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
163930112/228813984 [====================&gt;.........] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
177266688/228813984 [======================&gt;.......] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
190767104/228813984 [========================&gt;.....] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
204488704/228813984 [=========================&gt;....] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
217931776/228813984 [===========================&gt;..] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
228813984/228813984 [==============================] - 1s 0us/step
</pre></div>
</div>
</div>
</div>
<p>Cada directorio de la carpeta raíz contiene un directorio de cada clase</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">flowers_root</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sunflowers
LICENSE.txt
daisy
tulips
roses
dandelion
</pre></div>
</div>
</div>
</div>
<p>Cada archivo en los directorios son ejemplos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">flowers_root</span><span class="o">/</span><span class="s1">&#39;*/*&#39;</span><span class="p">))</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">list_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&#39;/home/runner/.keras/datasets/flower_photos/tulips/16138212287_643bf336e1_m.jpg&#39;
b&#39;/home/runner/.keras/datasets/flower_photos/sunflowers/9558632814_e78a780f4f.jpg&#39;
b&#39;/home/runner/.keras/datasets/flower_photos/dandelion/8723679596_391a724d4f_m.jpg&#39;
b&#39;/home/runner/.keras/datasets/flower_photos/sunflowers/6606753075_72ee32aa30_m.jpg&#39;
b&#39;/home/runner/.keras/datasets/flower_photos/daisy/10466558316_a7198b87e2.jpg&#39;
</pre></div>
</div>
</div>
</div>
<p>usando <code class="docutils literal notranslate"><span class="pre">tf.io.read_file</span></code> podemos ler los datos y extraer las etiquetas, obteniendo (imagen, etiqueta)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> <span class="n">label</span>

<span class="n">labeled_ds</span> <span class="o">=</span> <span class="n">list_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">image_raw</span><span class="p">,</span> <span class="n">label_text</span> <span class="ow">in</span> <span class="n">labeled_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">image_raw</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[:</span><span class="mi">100</span><span class="p">]))</span>
  <span class="nb">print</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">label_text</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&#39;\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x00\x00\x01\x00\x01\x00\x00\xff\xfe\x00\x0cAppleMark\n\xff\xe2\x05(ICC_PROFILE\x00\x01\x01\x00\x00\x05\x18appl\x02 \x00\x00scnrRGB XYZ \x07\xd3\x00\x07\x00\x01\x00\x00\x00\x00\x00\x00acspAPPL\x00\x00\x00\x00&#39;

b&#39;roses&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-4361ee-loteo-de-elementos-del-dataset-span">
<h2><span style="color:#4361EE">Loteo de elementos del dataset</span><a class="headerlink" href="#span-style-color-4361ee-loteo-de-elementos-del-dataset-span" title="Permalink to this headline">#</a></h2>
<section id="span-style-color-4cc9f0-loteo-simple-span">
<h3><span style="color:#4CC9F0">Loteo simple</span><a class="headerlink" href="#span-style-color-4cc9f0-loteo-simple-span" title="Permalink to this headline">#</a></h3>
<p>La transformación <code class="docutils literal notranslate"><span class="pre">Dataset.batch()</span></code> es la forma más sencilla de hacer un lote de <code class="docutils literal notranslate"><span class="pre">n</span></code> elementos consecutivos. Para cada componente, todos los elementos deben tener un tensor de exactamente la misma dimensión</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inc_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">dec_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">inc_dataset</span><span class="p">,</span> <span class="n">dec_dataset</span><span class="p">))</span>
<span class="n">batched_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batched_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">([</span><span class="n">arr</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[array([0, 1, 2, 3]), array([ 0, -1, -2, -3])]
[array([4, 5, 6, 7]), array([-4, -5, -6, -7])]
[array([ 8,  9, 10, 11]), array([ -8,  -9, -10, -11])]
[array([12, 13, 14, 15]), array([-12, -13, -14, -15])]
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-loteo-de-tensores-con-acolchamiento-span">
<h3><span style="color:#4CC9F0">Loteo de tensores con acolchamiento</span><a class="headerlink" href="#span-style-color-4cc9f0-loteo-de-tensores-con-acolchamiento-span" title="Permalink to this headline">#</a></h3>
<p>Con el loteo simple todos los tensores debe tener la misma dimensión, pero esto no va a ser el caso todas las veces. Utilizando <code class="docutils literal notranslate"><span class="pre">Dataset.padded_batch</span></code> se hace un acolchamiento de los tensores de distintas formas, específicando las dimensiones a las cuales hay que aplicar acolchamiento</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span> <span class="n">x</span><span class="p">))</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">padded_batch</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">padded_shapes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
  <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[0 0 0]
 [1 0 0]
 [2 2 0]
 [3 3 3]]

[[4 4 4 4 0 0 0]
 [5 5 5 5 5 0 0]
 [6 6 6 6 6 6 0]
 [7 7 7 7 7 7 7]]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-4361ee-flujo-de-entrenamiento-span">
<h2><span style="color:#4361EE">Flujo de entrenamiento</span><a class="headerlink" href="#span-style-color-4361ee-flujo-de-entrenamiento-span" title="Permalink to this headline">#</a></h2>
<section id="span-style-color-4cc9f0-procesando-multiples-epochs-span">
<h3><span style="color:#4CC9F0">Procesando múltiples epochs</span><a class="headerlink" href="#span-style-color-4cc9f0-procesando-multiples-epochs-span" title="Permalink to this headline">#</a></h3>
<p>La API ofrece dos maneras dde procesar múltiples epochs de los mismos datos.</p>
<p>La primera manera es iterando sobre el el conjunto de datos utilizando <code class="docutils literal notranslate"><span class="pre">Dataset.repeat()</span></code>. volvemos al ejemplo de texto del Titanic.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_batch_sizes</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
  <span class="n">batch_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">]</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_sizes</span><span class="p">)),</span> <span class="n">batch_sizes</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Batch number&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Batch size&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Dataset.repeat</span></code> hace una concatenación de los argumentos sin señalar el inicio o el final de un epoch. Si aplicamos
<code class="docutils literal notranslate"><span class="pre">Dataset.batch</span></code> Después de esta, se producirán lotes que van más allá de los límites e los epochs.</p>
<p>Si la función <code class="docutils literal notranslate"><span class="pre">repeat</span></code> no tiene argumentos, se hara una repetición infinita.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_batches</span> <span class="o">=</span> <span class="n">titanic_lines</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="n">plot_batch_sizes</span><span class="p">(</span><span class="n">titanic_batches</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/La_API_tf_data_103_0.png" src="../../_images/La_API_tf_data_103_0.png" />
</div>
</div>
<p>si queremos una separación clara de los epoch, se aplica <code class="docutils literal notranslate"><span class="pre">Dataset.batch</span></code> antes de <code class="docutils literal notranslate"><span class="pre">repeat</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titanic_batches</span> <span class="o">=</span> <span class="n">titanic_lines</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">plot_batch_sizes</span><span class="p">(</span><span class="n">titanic_batches</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/La_API_tf_data_105_0.png" src="../../_images/La_API_tf_data_105_0.png" />
</div>
</div>
<p>Si queremos, por ejemplo, recopilar estadísticas al final de cada epoch, podemos hacer una iteración y reiniciar después de cada epoch</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">titanic_lines</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End of epoch: &quot;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(128,)
(128,)
(128,)
(128,)
(116,)
End of epoch:  0
(128,)
(128,)
(128,)
(128,)
(116,)
End of epoch:  1
(128,)
(128,)
(128,)
(128,)
(116,)
End of epoch:  2
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-29 04:22:23.669507: W tensorflow/core/data/root_dataset.cc:247] Optimization loop failed: CANCELLED: Operation was cancelled
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-4361ee-mezclar-los-dato-de-entrada-span">
<h2><span style="color:#4361EE">Mezclar los dato de entrada</span><a class="headerlink" href="#span-style-color-4361ee-mezclar-los-dato-de-entrada-span" title="Permalink to this headline">#</a></h2>
<p>la transformación <code class="docutils literal notranslate"><span class="pre">Dataser.shuffle()</span></code> toma una muestra de un tamaño predeterminado y selecciona el siguiente dato del buffer.</p>
<p>Le agregaremos un indice a los datos del titanic para que el efecto sea visible</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lines</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">titanic_file</span><span class="p">)</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">counter</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">dataset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;BatchDataset element_spec=(TensorSpec(shape=(None,), dtype=tf.int64, name=None), TensorSpec(shape=(None,), dtype=tf.string, name=None))&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="p">,</span><span class="n">line_batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[  4  87  34  13  47  43  39  42 101  78  52  19  15   5  41  25  11  55
  81  76]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">shuffle</span></code> no señala el fin de un epoch hasta que el buffer esté vacío. si aplicamos <code class="docutils literal notranslate"><span class="pre">repeat</span></code> antes de este, se podrá ver el momento en el que termina un epoch y empieza otro</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">counter</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
<span class="n">shuffled</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;esta es la lista de indices cercanos al fin del epoch:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">line_batch</span> <span class="ow">in</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>esta es la lista de indices cercanos al fin del epoch:

[541 438 385 562 569 508 480 591 589 556]
[613 219 561 207 577 620 406 553 627 624]
[527 609 583 563 462 580 281 616]
[ 59  34  71  58  16  19 104  68  14  61]
[ 85 101  90  27  32  40   1 109   4  79]
</pre></div>
</div>
</div>
</div>
<p>gráficamente se puede apreciar mejor</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shuffle_repeat</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">line_batch</span> <span class="ow">in</span> <span class="n">shuffled</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shuffle_repeat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;shuffle().repeat()&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean item ID&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f9dd8178110&gt;
</pre></div>
</div>
<img alt="../../_images/La_API_tf_data_115_1.png" src="../../_images/La_API_tf_data_115_1.png" />
</div>
</div>
<p>si ponemos <code class="docutils literal notranslate"><span class="pre">repeat</span></code>antes de la mezcla, los límites de los epoch se mantendrán iguales hasta que no hayan más objetos que mezclar</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">counter</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
<span class="n">shuffled</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;esta es la lista de indices cercanos al fin del epoch:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">line_batch</span> <span class="ow">in</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>esta es la lista de indices cercanos al fin del epoch:

[584 570 547   9 411 530 622 381 572 582]
[ 30 612  32 443 507 588  27 614 501 560]
[ 19 553 176  42 482 520 606 616 592 610]
[625  39  26  54  37 518 549 421 618 604]
[608  10 567   5  17   4 623  40 558 587]
[ 49 598 224 602  31 594 480  53 275  79]
[599 516 464  38   2  36  25  69 596 255]
[603  20  28  74  48   8  75  51  90  57]
[ 65  66  67  82  47  72 106 565  60 346]
[ 44 499 600  33 100 111 441 105 118   1]
[597 455  81  14 515 468 103  41  56 617]
[ 64  73 403 104 605  98  89 102 621 126]
[414 498  58 620  99 119  96  18 116 110]
[ 22 578 521 154  61 101  11 131  35  55]
[ 16 545 133 577  34 524 185 473  91  23]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repeat_shuffle</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">line_batch</span> <span class="ow">in</span> <span class="n">shuffled</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shuffle_repeat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;shuffle().repeat()&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">repeat_shuffle</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;repeat().shuffle()&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean item ID&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f9dd800dc50&gt;
</pre></div>
</div>
<img alt="../../_images/La_API_tf_data_118_1.png" src="../../_images/La_API_tf_data_118_1.png" />
</div>
</div>
</section>
<section id="span-style-color-4361ee-preprocesamiento-de-datos-span">
<h2><span style="color:#4361EE">Preprocesamiento de datos</span><a class="headerlink" href="#span-style-color-4361ee-preprocesamiento-de-datos-span" title="Permalink to this headline">#</a></h2>
<p>si se quiere aplicar alguna función a los datos en cuestión, se utiliza  la transformación <code class="docutils literal notranslate"><span class="pre">Dataset.map(f)</span></code>. Esta toma los objetos <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">f.Tensor</span></code> de un solo elemento y saca nuevos objetos en un nuevo conjunto de datos.</p>
<p>Aquí mostramos dos ejemplos muy comunes de pre procesamiento</p>
<section id="span-style-color-4cc9f0-decodificando-imagenes-y-cambiar-su-tamano-span">
<h3><span style="color:#4CC9F0">Decodificando imagenes y cambiar su tamaño</span><a class="headerlink" href="#span-style-color-4cc9f0-decodificando-imagenes-y-cambiar-su-tamano-span" title="Permalink to this headline">#</a></h3>
<p>Al trabajar con imagenes de la vida cotidiana, lo más probable es que necesitemos estandarizar los tamaños a uno en común.</p>
<p>Utilizaremos la lista de flores para este ejemplo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">flowers_root</span><span class="o">/</span><span class="s1">&#39;*/*&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>escribimos una función para manipular datos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lee una imagen de un archivo, la decodifica en un tensor y cambia su tamaño</span>
<span class="c1"># a una forma predeterminada</span>
<span class="k">def</span> <span class="nf">parse_image</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
  <span class="n">parts</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file_path</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">list_ds</span><span class="p">))</span>
<span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">parse_image</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/La_API_tf_data_126_0.png" src="../../_images/La_API_tf_data_126_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">images_ds</span> <span class="o">=</span> <span class="n">list_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_image</span><span class="p">)</span>

<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">images_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/La_API_tf_data_127_0.png" src="../../_images/La_API_tf_data_127_0.png" />
<img alt="../../_images/La_API_tf_data_127_1.png" src="../../_images/La_API_tf_data_127_1.png" />
</div>
</div>
</section>
<section id="span-style-color-4cc9f0-aplicando-funciones-de-python-span">
<h3><span style="color:#4CC9F0">Aplicando funciones de Python</span><a class="headerlink" href="#span-style-color-4cc9f0-aplicando-funciones-de-python-span" title="Permalink to this headline">#</a></h3>
<p>Por razones de rendimiento, es mejor usar únicamente funciones de Tensorflow para manipular datos, pero a veces es necesario usar herramientas de otros paquetes de python.</p>
<p>Para esto utilizamos <code class="docutils literal notranslate"><span class="pre">tf.py_function()</span></code> como función en <code class="docutils literal notranslate"><span class="pre">Dataset.map()</span></code></p>
<p>Supongamos que queremos hacer una rotación aleatoria en un conjunto dde imágenes. Tensorflow sólo tiene <code class="docutils literal notranslate"><span class="pre">tf.image.rot90</span></code>, lo cual no sirve para la intención que se tiene. por suerte, el paquete scipy cuenta con <code class="docutils literal notranslate"><span class="pre">scipy.ndimage.rotate</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">ndimage</span>

<span class="k">def</span> <span class="nf">random_rotate_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">images_ds</span><span class="p">))</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">random_rotate_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<img alt="../../_images/La_API_tf_data_132_1.png" src="../../_images/La_API_tf_data_132_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tf_random_rotate_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
  <span class="n">im_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
  <span class="p">[</span><span class="n">image</span><span class="p">,]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span><span class="n">random_rotate_image</span><span class="p">,</span> <span class="p">[</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>
  <span class="n">image</span><span class="o">.</span><span class="n">set_shape</span><span class="p">(</span><span class="n">im_shape</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rot_ds</span> <span class="o">=</span> <span class="n">images_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tf_random_rotate_image</span><span class="p">)</span>

<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">rot_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">show</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</pre></div>
</div>
<img alt="../../_images/La_API_tf_data_134_2.png" src="../../_images/La_API_tf_data_134_2.png" />
<img alt="../../_images/La_API_tf_data_134_3.png" src="../../_images/La_API_tf_data_134_3.png" />
</div>
</div>
</section>
</section>
<section id="ventaneo-de-series-de-tiempo">
<h2>Ventaneo De series de tiempo<a class="headerlink" href="#ventaneo-de-series-de-tiempo" title="Permalink to this headline">#</a></h2>
<p>En el caso de modelos de series de tiempo, estos datos están organizados con el axis de tiempo intacto. Muchas veces se le alimentaran secciones de tiempo adyacentes a los modelos como datos. Hay dos maneras de generar estos cortes. La primera es utilizando lotes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">range_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batches</span> <span class="o">=</span> <span class="n">range_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2 3 4 5 6 7 8 9]
[10 11 12 13 14 15 16 17 18 19]
[20 21 22 23 24 25 26 27 28 29]
[30 31 32 33 34 35 36 37 38 39]
[40 41 42 43 44 45 46 47 48 49]
</pre></div>
</div>
</div>
</div>
<p>Para hacer predicciones un paso hacia el futuro, es ideal mover los datos y etiquetas un paso relativo a ellos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dense_1_step</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
  <span class="c1"># Se mueven las características y etiquetas un paso hacia la derecha</span>
  <span class="k">return</span> <span class="n">batch</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">predict_dense_1_step</span> <span class="o">=</span> <span class="n">batches</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dense_1_step</span><span class="p">)</span>

<span class="k">for</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">predict_dense_1_step</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot; =&gt; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2 3 4 5 6 7 8]  =&gt;  [1 2 3 4 5 6 7 8 9]
[10 11 12 13 14 15 16 17 18]  =&gt;  [11 12 13 14 15 16 17 18 19]
[20 21 22 23 24 25 26 27 28]  =&gt;  [21 22 23 24 25 26 27 28 29]
</pre></div>
</div>
</div>
</div>
<p>Para predecir una ventana completa de tiempo, podemos separar los lotes en dos partes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batches</span> <span class="o">=</span> <span class="n">range_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">label_next_5_steps</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">batch</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span>   <span class="c1"># Se toman los primeros 10 pasos</span>
          <span class="n">batch</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>   <span class="c1"># se toma el residuo</span>

<span class="n">predict_5_steps</span> <span class="o">=</span> <span class="n">batches</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">label_next_5_steps</span><span class="p">)</span>

<span class="k">for</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">predict_5_steps</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot; =&gt; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2 3 4 5 6 7 8 9]  =&gt;  [10 11 12 13 14]
[15 16 17 18 19 20 21 22 23 24]  =&gt;  [25 26 27 28 29]
[30 31 32 33 34 35 36 37 38 39]  =&gt;  [40 41 42 43 44]
</pre></div>
</div>
</div>
</div>
<p>Para permitir que se superpongan las características de un lote y las etiquetas de otro, podemos usar <code class="docutils literal notranslate"><span class="pre">Dataset.zip()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_length</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">label_length</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">features</span> <span class="o">=</span> <span class="n">range_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">feature_length</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">range_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">feature_length</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">labels</span><span class="p">:</span> <span class="n">labels</span><span class="p">[:</span><span class="n">label_length</span><span class="p">])</span>

<span class="n">predicted_steps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>

<span class="k">for</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">predicted_steps</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot; =&gt; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2 3 4 5 6 7 8 9]  =&gt;  [10 11 12]
[10 11 12 13 14 15 16 17 18 19]  =&gt;  [20 21 22]
[20 21 22 23 24 25 26 27 28 29]  =&gt;  [30 31 32]
[30 31 32 33 34 35 36 37 38 39]  =&gt;  [40 41 42]
[40 41 42 43 44 45 46 47 48 49]  =&gt;  [50 51 52]
</pre></div>
</div>
</div>
</div>
<p>Por supuesto, a veces se necesitan más control de las ventanas. Razón por la que se puede usar <code class="docutils literal notranslate"><span class="pre">Dataset.window</span></code>, pero para usarla correctamente, necesitamos algo de cuidado en lso datos. Esta transformación retorna un conjunto de conjuntos de datos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">window_size</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">windows</span> <span class="o">=</span> <span class="n">range_ds</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sub_ds</span> <span class="ow">in</span> <span class="n">windows</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">sub_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;
&lt;_VariantDataset element_spec=TensorSpec(shape=(), dtype=tf.int64, name=None)&gt;
</pre></div>
</div>
</div>
</div>
<p>¿Pero qué pasó aquí? para ver los datos como un solo conjunto, usamos <code class="docutils literal notranslate"><span class="pre">Dataset.flat_map</span></code>. Al mismo tiempo casi siempre es necesario hacer lotes</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">windows</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1 2 3 4 1 2 3 4 5 2 3 4 5 6 3 4 5 6 7 4 5 6 7 8 5 6 7 8 9 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sub_to_batch</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">sub</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">windows</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="n">sub_to_batch</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2 3 4]
[1 2 3 4 5]
[2 3 4 5 6]
[3 4 5 6 7]
[4 5 6 7 8]
</pre></div>
</div>
</div>
</div>
<p>Haciéndolo todo junto, obtendríamos una función como esta</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_window_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">windows</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">sub_to_batch</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sub</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="n">windows</span> <span class="o">=</span> <span class="n">windows</span><span class="o">.</span><span class="n">flat_map</span><span class="p">(</span><span class="n">sub_to_batch</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">windows</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">make_window_dataset</span><span class="p">(</span><span class="n">range_ds</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0  3  6  9 12 15 18 21 24 27]
[ 5  8 11 14 17 20 23 26 29 32]
[10 13 16 19 22 25 28 31 34 37]
[15 18 21 24 27 30 33 36 39 42]
[20 23 26 29 32 35 38 41 44 47]
[25 28 31 34 37 40 43 46 49 52]
[30 33 36 39 42 45 48 51 54 57]
[35 38 41 44 47 50 53 56 59 62]
[40 43 46 49 52 55 58 61 64 67]
[45 48 51 54 57 60 63 66 69 72]
</pre></div>
</div>
</div>
</div>
<p>Es sencillo extraer etiquetas con estos datos</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dense_labels_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">dense_1_step</span><span class="p">)</span>

<span class="k">for</span> <span class="n">inputs</span><span class="p">,</span><span class="n">labels</span> <span class="ow">in</span> <span class="n">dense_labels_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;=&gt;&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 0  3  6  9 12 15 18 21 24] =&gt; [ 3  6  9 12 15 18 21 24 27]
[ 5  8 11 14 17 20 23 26 29] =&gt; [ 8 11 14 17 20 23 26 29 32]
[10 13 16 19 22 25 28 31 34] =&gt; [13 16 19 22 25 28 31 34 37]
</pre></div>
</div>
</div>
</div>
</section>
<section id="span-style-color-4361ee-remuestreo-span">
<h2><span style="color:#4361EE">Remuestreo</span><a class="headerlink" href="#span-style-color-4361ee-remuestreo-span" title="Permalink to this headline">#</a></h2>
<p>Es usual encontrarse con datasets desbalanceados a nivel de clases. Es buena idea aquí el hacer un remuestreo del dataset. <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> da dos métodos para esto</p>
<p>Se usará el dataset de fraude de tarjetas de crédito es perfecto para demostrarlo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zip_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/data/creditcard.zip&#39;</span><span class="p">,</span>
    <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;creditcard.zip&#39;</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;/media/storage&#39;</span><span class="p">,</span>
    <span class="n">cache_subdir</span><span class="o">=</span><span class="s1">&#39;Datasets&#39;</span><span class="p">,</span>
    <span class="n">extract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">csv_path</span> <span class="o">=</span> <span class="n">zip_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/download.tensorflow.org/data/creditcard.zip
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    8192/69155632 [..............................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
 4202496/69155632 [&gt;.............................] - ETA: 1s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
14671872/69155632 [=====&gt;........................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
26525696/69155632 [==========&gt;...................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
33562624/69155632 [=============&gt;................] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
45228032/69155632 [==================&gt;...........] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
50339840/69155632 [====================&gt;.........] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
61300736/69155632 [=========================&gt;....] - ETA: 0s
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
69155632/69155632 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">creditcard_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
    <span class="n">csv_path</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">label_name</span><span class="o">=</span><span class="s2">&quot;Class&quot;</span><span class="p">,</span>
    <span class="c1"># Set the column types: 30 floats and an int.</span>
    <span class="n">column_defaults</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">()]</span><span class="o">*</span><span class="mi">30</span><span class="o">+</span><span class="p">[</span><span class="nb">int</span><span class="p">()])</span>
</pre></div>
</div>
</div>
</div>
<p>Se revisará ahora la distribución de las clases a clasificar, para ver qué tan sesgados están</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
  <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span>
  <span class="n">class_1</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span>
  <span class="n">class_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">class_1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

  <span class="n">class_0</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="n">class_0</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">class_0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

  <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;class_0&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">class_0</span><span class="p">)</span>
  <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;class_1&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">class_1</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">creditcard_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
    <span class="n">initial_state</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;class_0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;class_1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="n">reduce_func</span> <span class="o">=</span> <span class="n">count</span><span class="p">)</span>

<span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;class_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
                   <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;class_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">fractions</span> <span class="o">=</span> <span class="n">counts</span><span class="o">/</span><span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.9952 0.0048]
</pre></div>
</div>
</div>
</div>
<p>Para poder trabajar con datos desbalanceados, la mejor idea es balancearlos. Aquí algunos métodos para esto</p>
<section id="span-style-color-4cc9f0-muestreo-de-datasets-span">
<h3><span style="color:#4CC9F0">Muestreo de Datasets</span><a class="headerlink" href="#span-style-color-4cc9f0-muestreo-de-datasets-span" title="Permalink to this headline">#</a></h3>
<p>La forma más sencilla es usar <code class="docutils literal notranslate"><span class="pre">sample_from_datasets</span></code>. Esto es particularmente mejor cuando se tienen datasets separados por clase. Para este caso se va a filtrar los datos de fraude para esta razón</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">negative_ds</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">creditcard_ds</span>
    <span class="o">.</span><span class="n">unbatch</span><span class="p">()</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">label</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">repeat</span><span class="p">())</span>
<span class="n">positive_ds</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">creditcard_ds</span>
    <span class="o">.</span><span class="n">unbatch</span><span class="p">()</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">repeat</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">features</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">positive_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1 1 1 1 1 1 1 1 1 1]
</pre></div>
</div>
</div>
</div>
<p>Se pasarán los datasets, junto con los pesos que se quieren por <code class="docutils literal notranslate"><span class="pre">tf.data.experimental.sample_from_datasets</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">balanced_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">sample_from_datasets</span><span class="p">(</span>
    <span class="p">[</span><span class="n">negative_ds</span><span class="p">,</span> <span class="n">positive_ds</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /tmp/ipykernel_2007/929671245.py:2: sample_from_datasets_v2 (from tensorflow.python.data.experimental.ops.interleave_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.data.Dataset.sample_from_datasets(...)`.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /tmp/ipykernel_2007/929671245.py:2: sample_from_datasets_v2 (from tensorflow.python.data.experimental.ops.interleave_ops) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.data.Dataset.sample_from_datasets(...)`.
</pre></div>
</div>
</div>
</div>
<p>Ahora se generarán ejemplos de las clases con una probabilidad 50/50</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">balanced_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 0 0 1 0 1 0 0 0 1]
[0 1 0 1 0 1 1 1 1 1]
[1 0 0 1 1 0 1 1 1 0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 1 1 1 0 1 1 0 1]
[1 1 0 1 0 0 0 1 1 0]
[1 1 1 1 1 1 0 1 1 0]
[1 0 1 0 0 1 1 1 1 0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 0 0 1 0 1 1 0 0 1]
[0 1 1 1 1 1 1 0 1 0]
[1 0 1 0 1 0 0 0 0 1]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="span-style-color-4361ee-remuestreo-de-rechazo-span">
<h2><span style="color:#4361EE">Remuestreo de rechazo</span><a class="headerlink" href="#span-style-color-4361ee-remuestreo-de-rechazo-span" title="Permalink to this headline">#</a></h2>
<p>Como se dijo, necesitamos que los datasets estén separados por clase. Podemos por supuesto usar <code class="docutils literal notranslate"><span class="pre">Dataset.filter</span></code>, pero eso haría que los datos se cargaran dos veces.</p>
<p>La función <code class="docutils literal notranslate"><span class="pre">data.experimental.rejection_resample</span></code> permite rebalancear los datos sin tener que cargarlos otra vez. Esto se logra eliminando elementos del dataset para llegar al balance.</p>
<p>Esta función toma un argumento <code class="docutils literal notranslate"><span class="pre">class_func</span></code>. Esta función es aplicada a cada elemento del dataset para determinar la clase que tiene.</p>
<p>Los elementos de <code class="docutils literal notranslate"><span class="pre">creditcard_ds</span></code> ya están separados en pares <code class="docutils literal notranslate"><span class="pre">(features,label)</span></code>. Así que la función solo tiene que retornar la etiqueta</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">class_func</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">label</span>
</pre></div>
</div>
</div>
</div>
<p>De igual forma es necesaria una distribución objetivo y preferiblemente un estimado de esta</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resampler</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">rejection_resample</span><span class="p">(</span>
    <span class="n">class_func</span><span class="p">,</span> <span class="n">target_dist</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">initial_dist</span><span class="o">=</span><span class="n">fractions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /tmp/ipykernel_2007/2462412449.py:2: rejection_resample (from tensorflow.python.data.experimental.ops.resampling) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.data.Dataset.rejection_resample(...)`.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /tmp/ipykernel_2007/2462412449.py:2: rejection_resample (from tensorflow.python.data.experimental.ops.resampling) is deprecated and will be removed in a future version.
Instructions for updating:
Use `tf.data.Dataset.rejection_resample(...)`.
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">resampler</span></code> trabaja con las observaciones de manera individual, así que hay que aplicar <code class="docutils literal notranslate"><span class="pre">unbatch()</span></code> antes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resample_ds</span> <span class="o">=</span> <span class="n">creditcard_ds</span><span class="o">.</span><span class="n">unbatch</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">resampler</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /opt/hostedtoolcache/Python/3.7.13/x64/lib/python3.7/site-packages/tensorflow/python/data/ops/dataset_ops.py:5825: Print (from tensorflow.python.ops.logging_ops) is deprecated and will be removed after 2018-08-20.
Instructions for updating:
Use tf.print instead of tf.Print. Note that tf.print returns a no-output operator that directly prints the output. Outside of defuns or eager mode, this operator will not be executed unless it is directly specified in session.run or used as a control dependency for other operators. This is only a concern in graph mode. Below is an example of how to ensure tf.print executes in graph mode:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:From /opt/hostedtoolcache/Python/3.7.13/x64/lib/python3.7/site-packages/tensorflow/python/data/ops/dataset_ops.py:5825: Print (from tensorflow.python.ops.logging_ops) is deprecated and will be removed after 2018-08-20.
Instructions for updating:
Use tf.print instead of tf.Print. Note that tf.print returns a no-output operator that directly prints the output. Outside of defuns or eager mode, this operator will not be executed unless it is directly specified in session.run or used as a control dependency for other operators. This is only a concern in graph mode. Below is an example of how to ensure tf.print executes in graph mode:
</pre></div>
</div>
</div>
</div>
<p>el resampler retorna pares del tipo <code class="docutils literal notranslate"><span class="pre">(class,</span> <span class="pre">example)</span></code> a partír de la salida de <code class="docutils literal notranslate"><span class="pre">class_func</span></code>. En este caso ya tenemos <code class="docutils literal notranslate"><span class="pre">(feature,</span> <span class="pre">label)</span></code>, así que se hace un map para obtener una copia extra de las etiquetas</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">balanced_ds</span> <span class="o">=</span> <span class="n">resample_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">extra_label</span><span class="p">,</span> <span class="n">features_and_label</span><span class="p">:</span> <span class="n">features_and_label</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="ow">in</span> <span class="n">balanced_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
Proportion of examples rejected by sampler is high: [0.99521482][0.99521482 0.00478515634][0 1]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 1 1 0 1 0 1 1 0]
[0 0 1 1 0 0 0 1 0 1]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1 0 0 0 0 0 0 0 1 1]
[0 0 1 1 0 1 1 0 0 0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1 0 1 0 1 1 1 0 0 0]
[0 1 0 0 0 0 1 1 0 1]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 1 0 0 1 0 1 1 0]
[1 1 0 0 1 1 1 0 1 0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1 0 0 1 0 1 1 0 1 1]
[0 1 1 1 0 1 0 1 1 0]
</pre></div>
</div>
</div>
</div>
<p>Cuál es el problema de este método? si el desbalanceo es muy grande, se va a perder una cantidad muy grande de datos. ¿Qué es más importante: La cantidad de datos o la cantidad de recursos?</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "AprendizajeProfundo/Libro_Fundamentos_Programacion",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Python/Cuadernos"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Álvaro Mauricio Montenegro Díaz, Daniel Mauricio Montenegro Reyes<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>